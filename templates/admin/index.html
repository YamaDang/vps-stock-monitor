<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>管理员控制台 - VPS库存监控系统</title>
    <link rel="stylesheet" href="https://unpkg.com/element-plus@2.3.8/dist/index.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #f5f7fa;
        }
        .container {
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .title {
            margin: 0;
            color: #1f2329;
        }
        .card {
            margin-bottom: 20px;
        }
        .operation-buttons {
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
        }
        .form-item {
            margin-bottom: 15px;
        }
        .tabs-container {
            margin-top: 15px;
        }
        .footer {
            text-align: center;
            margin-top: 30px;
            color: #86909c;
            font-size: 0.9rem;
        }
        .user-menu {
            display: flex;
            align-items: center;
        }
        .user-menu .el-dropdown-link {
            display: flex;
            align-items: center;
            color: #409eff;
            cursor: pointer;
        }
        .user-menu .el-icon-arrow-down {
            margin-left: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="title">VPS库存监控系统 - 管理员控制台</h1>
            <div class="user-menu">
                <el-dropdown>
                    <span class="el-dropdown-link">
                        <i class="fa fa-user-circle-o" style="font-size: 18px; margin-right: 5px;"></i>
                        admin
                        <i class="el-icon-arrow-down el-icon--right"></i>
                    </span>
                    <template #dropdown>
                        <el-dropdown-menu>
                            <el-dropdown-item @click="goToProfile">
                                <i class="fa fa-cog" style="margin-right: 5px;"></i>个人设置
                            </el-dropdown-item>
                            <el-dropdown-item @click="handleLogout">
                                <i class="fa fa-sign-out" style="margin-right: 5px;"></i>退出登录
                            </el-dropdown-item>
                        </el-dropdown-menu>
                    </template>
                </el-dropdown>
            </div>
        </div>
        
        <div id="app">
            <el-card class="card">
                <el-tabs v-model="activeTab" class="tabs-container">
                    <el-tab-pane label="监控列表" name="stock-list">
                        <div class="operation-buttons">
                            <el-button type="primary" @click="showAddStockDialog">
                                <i class="fa fa-plus" style="margin-right: 5px;"></i>添加监控项
                            </el-button>
                            <el-button type="info" @click="refreshStockList">
                                <i class="fa fa-refresh" style="margin-right: 5px;"></i>刷新列表
                            </el-button>
                        </div>
                        
                        <el-table 
                            :data="stockList" 
                            border 
                            style="width: 100%;"
                            v-loading="stockLoading">
                            <el-table-column 
                                prop="name" 
                                label="商品名称" 
                                sortable>
                            </el-table-column>
                            <el-table-column 
                                label="商品链接">
                                <template #default="scope">
                                    <a :href="scope.row.url" target="_blank">
                                        {{ scope.row.url.length > 60 ? scope.row.url.substring(0, 60) + '...' : scope.row.url }}
                                    </a>
                                </template>
                            </el-table-column>
                            <el-table-column 
                                label="库存状态" 
                                sortable>
                                <template #default="scope">
                                    <el-badge 
                                        :value="scope.row.status ? '有货' : '无货'" 
                                        :type="scope.row.status ? 'success' : 'danger'"
                                        size="large">
                                    </el-badge>
                                </template>
                            </el-table-column>
                            <el-table-column 
                                prop="last_changed" 
                                label="状态更新时间"
                                sortable>
                            </el-table-column>
                            <el-table-column 
                                label="操作" 
                                width="120">
                                <template #default="scope">
                                    <el-button 
                                        type="danger" 
                                        size="mini" 
                                        @click="handleDeleteStock(scope.row.name)">
                                        删除
                                    </el-button>
                                </template>
                            </el-table-column>
                        </el-table>
                        
                        <div v-if="stockList.length === 0 && !stockLoading" class="empty-state">
                            <el-empty description="暂无监控商品，请添加"></el-empty>
                        </div>
                    </el-tab-pane>
                    
                    <el-tab-pane label="系统设置" name="system-settings">
                        <el-form 
                            ref="configForm" 
                            :model="configForm" 
                            label-width="150px"
                            v-loading="configLoading">
                            <el-form-item label="监控频率(秒)" prop="frequency" class="form-item">
                                <el-input 
                                    v-model.number="configForm.frequency" 
                                    min="10" 
                                    placeholder="请输入监控频率，单位：秒，最小10秒">
                                </el-input>
                                <div class="el-form-item__help">监控商品库存的时间间隔，建议设置30秒以上</div>
                            </el-form-item>
                            
                            <el-form-item label="通知方式" prop="notice_type" class="form-item">
                                <el-radio-group v-model="configForm.notice_type">
                                    <el-radio label="telegram">Telegram</el-radio>
                                    <el-radio label="wechat">微信(息知)</el-radio>
                                    <el-radio label="custom">自定义URL</el-radio>
                                </el-radio-group>
                            </el-form-item>
                            
                            <template v-if="configForm.notice_type === 'telegram'">
                                <el-form-item label="Telegram Bot Token" prop="telegrambot" class="form-item">
                                    <el-input 
                                        v-model="configForm.telegrambot" 
                                        placeholder="请输入Telegram机器人Token">
                                    </el-input>
                                    <div class="el-form-item__help">创建机器人后从@BotFather获取的Token</div>
                                </el-form-item>
                                
                                <el-form-item label="Telegram Chat ID" prop="chat_id" class="form-item">
                                    <el-input 
                                        v-model="configForm.chat_id" 
                                        placeholder="请输入接收通知的Chat ID">
                                    </el-input>
                                    <div class="el-form-item__help">可以通过@getidsbot获取</div>
                                </el-form-item>
                            </template>
                            
                            <template v-if="configForm.notice_type === 'wechat'">
                                <el-form-item label="息知KEY" prop="wechat_key" class="form-item">
                                    <el-input 
                                        v-model="configForm.wechat_key" 
                                        placeholder="请输入息知KEY">
                                    </el-input>
                                    <div class="el-form-item__help">从<a href="https://xizhi.qqoq.net/" target="_blank">息知官网</a>获取的KEY</div>
                                </el-form-item>
                            </template>
                            
                            <template v-if="configForm.notice_type === 'custom'">
                                <el-form-item label="自定义通知URL" prop="custom_url" class="form-item">
                                    <el-input 
                                        v-model="configForm.custom_url" 
                                        placeholder="请输入包含{message}占位符的URL">
                                    </el-input>
                                    <div class="el-form-item__help">
                                        URL中需包含{message}作为消息占位符，例如：<br>
                                        https://example.com/notify?msg={message}
                                    </div>
                                </el-form-item>
                            </template>
                            
                            <el-form-item class="form-item">
                                <el-button type="primary" @click="saveConfig">保存配置</el-button>
                                <el-button @click="resetConfig">重置</el-button>
                                <el-button type="warning" @click="reloadConfig">重新加载配置</el-button>
                            </el-form-item>
                        </el-form>
                    </el-tab-pane>
                </el-tabs>
            </el-card>
            
            <div class="footer">
                <p>VPS库存监控系统 &copy; {{ new Date().getFullYear() }}</p>
            </div>
            
            <!-- 添加监控项对话框 -->
            <el-dialog 
                title="添加监控商品" 
                v-model="addStockDialogVisible" 
                width="500px">
                <el-form 
                    ref="addStockForm" 
                    :model="addStockForm" 
                    label-width="100px">
                    <el-form-item 
                        label="商品名称" 
                        prop="name"
                        :rules="[{ required: true, message: '请输入商品名称', trigger: 'blur' }]">
                        <el-input v-model="addStockForm.name" placeholder="请输入商品名称"></el-input>
                    </el-form-item>
                    <el-form-item 
                        label="商品URL" 
                        prop="url"
                        :rules="[{ required: true, message: '请输入商品URL', trigger: 'blur' }]">
                        <el-input v-model="addStockForm.url" placeholder="请输入商品详情页URL"></el-input>
                    </el-form-item>
                </el-form>
                <template #footer>
                    <el-button @click="addStockDialogVisible = false">取消</el-button>
                    <el-button type="primary" @click="handleAddStock">确定</el-button>
                </template>
            </el-dialog>
        </div>
    </div>

    <script src="https://unpkg.com/vue@3.2.47/dist/vue.global.js"></script>
    <script src="https://unpkg.com/element-plus@2.3.8/dist/index.full.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script>
        const { createApp, ref, reactive, toRefs, onMounted, getCurrentInstance } = Vue;
        
        createApp({
            setup() {
                // 状态管理
                const state = reactive({
                    activeTab: 'stock-list',
                    stockList: [],
                    stockLoading: false,
                    addStockDialogVisible: false,
                    configForm: {
                        frequency: 30,
                        notice_type: 'telegram',
                        telegrambot: '',
                        chat_id: '',
                        wechat_key: '',
                        custom_url: ''
                    },
                    configLoading: false,
                    addStockForm: {
                        name: '',
                        url: ''
                    }
                });
                
                // 获取库存列表
                const fetchStockList = async () => {
                    try {
                        state.stockLoading = true;
                        const response = await axios.get('/admin/api/stocks');
                        state.stockList = response.data || [];
                    } catch (error) {
                        console.error('获取库存列表失败:', error);
                        ElMessage.error('获取库存列表失败');
                    } finally {
                        state.stockLoading = false;
                    }
                };
                
                // 获取系统配置
                const fetchConfig = async () => {
                    try {
                        state.configLoading = true;
                        const response = await axios.get('/admin/api/config');
                        state.configForm = { ...state.configForm, ...response.data };
                    } catch (error) {
                        console.error('获取系统配置失败:', error);
                        ElMessage.error('获取系统配置失败');
                    } finally {
                        state.configLoading = false;
                    }
                };
                
                // 保存系统配置
                const saveConfig = async () => {
                    try {
                        await axios.post('/admin/api/config', state.configForm);
                        ElMessage.success('配置保存成功');
                    } catch (error) {
                        console.error('保存配置失败:', error);
                        ElMessage.error(error.response?.data?.message || '保存配置失败');
                    }
                };
                
                // 重置配置表单
                const resetConfig = () => {
                    fetchConfig(); // 重新获取配置
                    ElMessage.info('配置已重置为当前保存的值');
                };
                
                // 重新加载配置
                const reloadConfig = async () => {
                    try {
                        await axios.post('/admin/api/reload');
                        await fetchConfig();
                        await fetchStockList();
                        ElMessage.success('配置已重新加载');
                    } catch (error) {
                        console.error('重新加载配置失败:', error);
                        ElMessage.error('重新加载配置失败');
                    }
                };
                
                // 显示添加监控项对话框
                const showAddStockDialog = () => {
                    state.addStockForm = { name: '', url: '' };
                    state.addStockDialogVisible = true;
                };
                
                // 添加监控项
                const handleAddStock = async () => {
                    try {
                        // 简单验证
                        if (!state.addStockForm.name.trim()) {
                            ElMessage.warning('请输入商品名称');
                            return;
                        }
                        if (!state.addStockForm.url.trim()) {
                            ElMessage.warning('请输入商品URL');
                            return;
                        }
                        
                        await axios.post('/admin/api/stocks', state.addStockForm);
                        state.addStockDialogVisible = false;
                        await fetchStockList();
                        ElMessage.success(`已添加监控项: ${state.addStockForm.name}`);
                    } catch (error) {
                        console.error('添加监控项失败:', error);
                        ElMessage.error(error.response?.data?.message || '添加监控项失败');
                    }
                };
                
                // 删除监控项
                const handleDeleteStock = async (name) => {
                    try {
                        await ElMessageBox.confirm(
                            `确定要删除监控项"${name}"吗？`,
                            '确认删除',
                            {
                                confirmButtonText: '确定',
                                cancelButtonText: '取消',
                                type: 'warning'
                            }
                        );
                        
                        await axios.delete('/admin/api/stocks', {
                            data: { name: name }
                        });
                        
                        await fetchStockList();
                        ElMessage.success(`已删除监控项: ${name}`);
                    } catch (error) {
                        if (error.name !== 'Cancel') { // 不是用户取消操作
                            console.error('删除监控项失败:', error);
                            ElMessage.error(error.response?.data?.message || '删除监控项失败');
                        }
                    }
                };
                
                // 刷新库存列表
                const refreshStockList = async () => {
                    await fetchStockList();
                    ElMessage.success('列表已刷新');
                };
                
                // 跳转到个人设置
                const goToProfile = () => {
                    window.location.href = '/admin/profile';
                };
                
                // 退出登录
                const handleLogout = async () => {
                    try {
                        await axios.get('/logout');
                        window.location.href = '/';
                    } catch (error) {
                        console.error('退出登录失败:', error);
                        ElMessage.error('退出登录失败');
                    }
                };
                
                // 初始化
                onMounted(() => {
                    fetchStockList();
                    fetchConfig();
                });
                
                return {
                    ...toRefs(state),
                    fetchStockList,
                    fetchConfig,
                    saveConfig,
                    resetConfig,
                    reloadConfig,
                    showAddStockDialog,
                    handleAddStock,
                    handleDeleteStock,
                    refreshStockList,
                    goToProfile,
                    handleLogout
                };
            }
        }).use(ElementPlus).mount('#app');
    </script>
</body>
</html>
